---

#
# common tasks suitable for all machines
#

- name: gather facts
  setup: gather_subset=hardware

# setting hostname is not supported for all os'es. see
# https://github.com/ansible/ansible-modules-core/issues/4818
# https://github.com/ansible/ansible-modules-core/issues/4782
# also, some os'es complain about underscores in hostnames
- name: set hostname
  when: not os|startswith("alpine") and not os|startswith("smartos")
  hostname: name="{{ inventory_hostname|replace('_', '-') }}"

- name: create group
  group: name="{{ server_user }}"

- name: create the active user
  user: name="{{ server_user }}" group="{{ server_user }}" shell=/bin/bash

- name: add ::1 to /etc/hosts for ipv6 compat
  lineinfile:
    dest: /etc/hosts
    state: present
    line: ::1 localhost.localdomain localhost

- name: disable joyent smartconnect
  when: os|startswith("smartos")
  notify: restart sshd
  lineinfile: state=absent dest="{{ ssh_config }}" regexp=libsmartsshd.so

- name: change default coredump folder
  when: os|startswith("smartos")
  shell: coreadm -g /home/iojs/cores/core.%f.%p -e global

- name: disable sftp
  when: not os|startswith("win")
  notify: restart sshd
  lineinfile: state=absent dest="{{ ssh_config }}" regexp=^Subsystem(\s+)sftp

- name: add os-specific repos
  include: "{{ repos_include }}"
  loop_control:
    loop_var: repos_include
  with_first_found:
    - files:
        - "{{ role_path }}/tasks/partials/repo/{{ os }}.yml"
        - "{{ role_path }}/tasks/partials/repo/{{ os|stripversion }}.yml"
      skip: true

- name: install packages
  package: name="{{ package }}" state=present
  loop_control:
    loop_var: package
  with_flattened:
  # ansible doesn't like empty lists
    - "{{ packages[os]|default('[]') }}"
    - "{{ packages[os|stripversion]|default('[]') }}"
    - "{{ common_packages|default('[]') }}"

- name: check for ccache
  when: os in ccache_no_binpkg
  stat: path="{{ ccache_dest }}"
  register: has_ccache

- name: run ccache installer
  when: os in ccache_no_binpkg and not has_ccache.stat.exists
  include: ccache.yml
  static: false
  vars:
    - version: 3.3.2

- name: set up ntp
  include: "{{ ntp_include }}"
  loop_control:
    loop_var: ntp_include
  with_first_found:
    - files:
        - "{{ role_path }}/tasks/partials/ntp/{{ os }}.yml"
        - "{{ role_path }}/tasks/partials/ntp/{{ os|stripversion }}.yml"
        - "{{ role_path }}/tasks/partials/ntp/{{ os|match_key(ntp_service, raise_error=False) }}.yml"
      skip: true
